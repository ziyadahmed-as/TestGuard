{% extends "base.html" %}
{% load humanize %}

{% block title %}Exam Results - {{ attempt.exam.title }} - AcademicGuard{% endblock %}

{% block breadcrumbs %}
<nav class="flex mb-6" aria-label="Breadcrumb">
    <ol class="inline-flex items-center space-x-1 md:space-x-3">
        <li class="inline-flex items-center">
            <a href="{% url 'dashboard' %}" class="inline-flex items-center text-sm font-medium text-gray-500 hover:text-primary-600">
                <i class="fas fa-home mr-2"></i>
                Dashboard
            </a>
        </li>
        <li>
            <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                <a href="{% url 'exams:exam_list' %}" class="ml-1 text-sm font-medium text-gray-500 hover:text-primary-600 md:ml-2">Exams</a>
            </div>
        </li>
        <li>
            <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                <a href="{% url 'exams:exam_detail' attempt.exam.pk %}" class="ml-1 text-sm font-medium text-gray-500 hover:text-primary-600 md:ml-2">{{ attempt.exam.title }}</a>
            </div>
        </li>
        <li aria-current="page">
            <div class="flex items-center">
                <i class="fas fa-chevron-right text-gray-400 mx-2"></i>
                <span class="ml-1 text-sm font-medium text-gray-500 md:ml-2">Results</span>
            </div>
        </li>
    </ol>
</nav>
{% endblock %}

{% block page_title %}Exam Results - {{ attempt.exam.title }}{% endblock %}
{% block page_description %}Review your performance on this exam attempt{% endblock %}

{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Results Summary -->
    <div class="lg:col-span-2">
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-5">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="text-lg font-medium text-gray-900">Exam Results</h3>
                        <p class="text-sm text-gray-500">Attempt on {{ attempt.start_time|date:"F j, Y" }}</p>
                    </div>
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium 
                        {% if passed %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                        {% if passed %}Passed{% else %}Not Passed{% endif %}
                    </span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                        <p class="text-3xl font-bold text-gray-900">{{ attempt.score }}%</p>
                        <p class="text-sm text-gray-600">Overall Score</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                        <p class="text-3xl font-bold text-gray-900">{{ correct_answers }}/{{ total_questions }}</p>
                        <p class="text-sm text-gray-600">Correct Answers</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg text-center">
                        <p class="text-3xl font-bold text-gray-900">{{ attempt.duration|floatformat:1 }} min</p>
                        <p class="text-sm text-gray-600">Time Taken</p>
                    </div>
                </div>
                
                <!-- Score Comparison -->
                <div class="mb-6">
                    <h4 class="text-sm font-medium text-gray-900 mb-2">Performance Comparison</h4>
                    <div class="bg-gray-100 rounded-full h-4 mb-2">
                        <div class="bg-primary-600 h-4 rounded-full" style="width: {{ attempt.score }}%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-600">
                        <span>Your Score: {{ attempt.score }}%</span>
                        <span>Passing Score: {{ attempt.exam.pass_percentage }}%</span>
                    </div>
                </div>
                
                <!-- Exam Details -->
                <div class="border-t border-gray-200 pt-4">
                    <h4 class="text-sm font-medium text-gray-900 mb-2">Exam Details</h4>
                    <div class="grid grid-cols-2 gap-4 text-sm">
                        <div>
                            <p class="text-gray-600">Status</p>
                            <p class="font-medium">{{ attempt.get_status_display }}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Started</p>
                            <p class="font-medium">{{ attempt.start_time|date:"M j, Y H:i" }}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Submitted</p>
                            <p class="font-medium">{{ attempt.end_time|date:"M j, Y H:i" }}</p>
                        </div>
                        <div>
                            <p class="text-gray-600">Duration</p>
                            <p class="font-medium">{{ attempt.duration|floatformat:1 }} minutes</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Question Review -->
        <div class="mt-6 bg-white shadow rounded-lg">
            <div class="px-6 py-5">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Question Review</h3>
                
                <div class="space-y-6">
                    {% for response in responses %}
                    <div class="border border-gray-200 rounded-lg p-4 {% if response.points_awarded == response.question.points %}border-green-200 bg-green-50{% elif response.points_awarded > 0 %}border-yellow-200 bg-yellow-50{% else %}border-red-200 bg-red-50{% endif %}">
                        <div class="flex justify-between items-start mb-2">
                            <h4 class="text-md font-medium text-gray-900">Question {{ forloop.counter }}</h4>
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium 
                                {% if response.points_awarded == response.question.points %}bg-green-100 text-green-800
                                {% elif response.points_awarded > 0 %}bg-yellow-100 text-yellow-800
                                {% else %}bg-red-100 text-red-800{% endif %}">
                                {{ response.points_awarded|default:0 }}/{{ response.question.points }} points
                            </span>
                        </div>
                        
                        <div class="prose prose-sm max-w-none mb-4">
                            <p class="text-gray-800">{{ response.question.question_text }}</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-1">Your Answer</p>
                                <div class="bg-white p-3 rounded-md border border-gray-200">
                                    {% if response.student_answer %}
                                        {% if response.question.type == 'MC' or response.question.type == 'TF' %}
                                            <p class="text-sm">{{ response.student_answer }}</p>
                                        {% else %}
                                            <p class="text-sm">{{ response.student_answer }}</p>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-sm text-gray-500 italic">No answer provided</p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if response.question.requires_manual_grading and not response.is_graded %}
                            <div>
                                <p class="text-sm font-medium text-gray-700 mb-1">Grading Status</p>
                                <div class="bg-yellow-50 p-3 rounded-md border border-yellow-200">
                                    <p class="text-sm text-yellow-800">Awaiting manual grading</p>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                        
                        {% if response.question.learning_objective %}
                        <div class="bg-gray-50 p-3 rounded-md mt-2">
                            <p class="text-xs text-gray-600"><strong>Learning Objective:</strong> {{ response.question.learning_objective }}</p>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="space-y-6">
        <!-- Actions -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-5">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Actions</h3>
                
                <div class="space-y-3">
                    <a href="{% url 'exams:exam_detail' attempt.exam.pk %}" class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-arrow-left mr-2"></i> Back to Exam
                    </a>
                    
                    {% if attempt.exam.attempts.filter.student=user.count < attempt.exam.max_attempts %}
                    <a href="{% url 'exams:exam_start' attempt.exam.pk %}" class="w-full inline-flex justify-center items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-redo mr-2"></i> Try Again
                    </a>
                    {% endif %}
                    
                    <button onclick="window.print()" class="w-full inline-flex justify-center items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                        <i class="fas fa-print mr-2"></i> Print Results
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Performance Breakdown -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-5">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Performance Breakdown</h3>
                
                <div class="space-y-4">
                    {% for type in question_types %}
                    <div>
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-sm font-medium text-gray-700">{{ type.name }}</span>
                            <span class="text-sm text-gray-500">{{ type.correct }}/{{ type.total }}</span>
                        </div>
                        <div class="bg-gray-200 rounded-full h-2">
                            <div class="bg-primary-600 h-2 rounded-full" style="width: {% widthratio type.correct type.total 100 %}%"></div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Time Analysis -->
        <div class="bg-white shadow rounded-lg">
            <div class="px-6 py-5">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Time Analysis</h3>
                
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Time Allotted</span>
                        <span class="font-medium">{{ attempt.exam.duration }} minutes</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Time Used</span>
                        <span class="font-medium">{{ attempt.duration|floatformat:1 }} minutes</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Time per Question</span>
                        <span class="font-medium">{{ time_per_question|floatformat:1 }} minutes</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Print functionality
function printResults() {
    window.print();
}

// Download as PDF (would need a proper PDF generation solution)
function downloadAsPDF() {
    alert('PDF download functionality would be implemented with a proper PDF generation library.');
}
</script>
{% endblock %}